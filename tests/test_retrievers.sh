#!/bin/bash
# Copyright (C) 2024 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

set -xe

WORKPATH=$(dirname "$PWD")
ip_address=$(hostname -I | awk '{print $1}')
function build_docker_images() {
    cd $WORKPATH
    docker build --no-cache -t opea/retriever-redis:comps -f comps/retrievers/langchain/docker/Dockerfile .
}

function start_service() {
    # tei endpoint
    tei_endpoint=5008
    model="BAAI/bge-large-en-v1.5"
    revision="refs/pr/5"
    docker run -d --name="test-comps-retriever-tei-endpoint" -p $tei_endpoint:80 -v ./data:/data --pull always ghcr.io/huggingface/text-embeddings-inference:cpu-1.2 --model-id $model --revision $revision
    export TEI_EMBEDDING_ENDPOINT="http://${ip_address}:${tei_endpoint}"

    # redis retriever
    export REDIS_URL="redis://${ip_address}:6379"
    export INDEX_NAME="rag-redis"
    retriever_port=5009
    unset http_proxy
    docker run -d --name="test-comps-retriever-redis-server" -p ${retriever_port}:7000 --ipc=host -e TEI_EMBEDDING_ENDPOINT=$TEI_EMBEDDING_ENDPOINT -e http_proxy=$http_proxy -e https_proxy=$https_proxy -e REDIS_URL=$REDIS_URL -e INDEX_NAME=$INDEX_NAME opea/retriever-redis:comps

    sleep 3m
}

function validate_microservice() {
    retriever_port=5009
    export PATH="${HOME}/miniforge3/bin:$PATH"
    source activate
    # test_embedding=$(python -c "import random; embedding = [random.uniform(-1, 1) for _ in range(768)]; print(embedding)")
    http_proxy= curl http://${ip_address}:$retriever_port/v1/retrieval -X POST -d '{"text":"test","embedding":[0.3673416638447011, 0.5954679756527812, -0.6287529429745735, 0.49567077081295685, -0.24609799147172673, 0.6154841057287854, 0.9235333026204471, 0.11271431256725695, -0.14053103078659146, 0.34776647547213124, -0.7711089310641368, -0.19857062369322853, 0.10299470203277705, -0.3865627968160108, -0.5709009265575016, 0.6025671578489915, -0.9420726273658879, 0.21599584042341702, 0.1944443717607529, 0.3323329779785138, -0.37772427436184675, 0.48225282182209495, 0.4631707458999492, 0.584259034911006, 0.3210184335140822, -0.5038919578137977, 0.9443054500365913, -0.6097189015942504, -0.21160907627855297, 0.5154813810028445, -0.7645348067658249, 0.8409005023370641, 0.06336765141981604, 0.24765311623535302, -0.5523428812069395, 0.43175855262361695, -0.8797629629836927, -0.2443010932031442, -0.6670809381931486, 0.6642438844138832, -0.46967144010717465, 0.448303999038125, -0.3735279402724174, -0.3097471807457066, 0.6264177449074149, 0.4911031067723284, -0.0726590699022247, 0.02341732999464674, 0.6671538397210912, -0.8599581159881358, 0.18303402436191707, 0.6086579163461279, 0.7425644714416622, 0.05053269033204222, 0.7779794071512778, -0.32801658581099113, -0.8677392851615773, -0.5037429202758434, 0.10052472688699265, 0.29738319365421817, 0.47618620890879937, -0.9221080602815881, 0.3154375460388301, 0.1550927903292567, -0.7147602525062609, 0.8281165813020628, 0.7286321687138815, -0.7441101892993962, 0.3805446174101763, -0.8998941759092947, 0.31861329125206006, -0.7112859263373956, 0.8087363552193274, 0.8113469792740684, 0.40143503197008523, -0.7554624238874148, 0.36495334724382955, 0.1665062362648415, 0.20330761740318204, -0.9333716487162995, -0.6680008582837145, 0.27468623068364084, 0.29232447736688116, -0.5847548550999564, 0.33850805589914845, -0.9198243658191363, 0.7378848983265884, -0.03580398347371894, -0.8251920226236209, -0.8518763853321345, -0.09790286809627369, 0.03034742044678329, -0.1319753696756043, 0.4150892254719629, 0.7002558685859024, -0.08946368639662228, -0.41574413945054123, 0.5783445198857806, -0.9431094357610235, -0.8652448184618378, 0.7724912053785631, -0.11949300000569574, 0.6113947641687953, -0.05226157770993556, -0.02135131747174146, 0.08630918422896183, 0.3212496510065961, -0.659065000208678, 0.3492327560442694, -0.46105891108631436, 0.031156240362238297, 0.3566967088258177, 0.11640554215320353, 0.8009409994421319, 0.7034061253487442, 0.9580335654566445, 0.5652505795551941, -0.6917109629221765, -0.14020430609198464, 0.8045339138605676, 0.1744955659352312, -0.11868888520260001, 0.7611364848629014, 0.7523679496507989, 0.17160980845834928, -0.8455166710539095, 0.7631727708585812, -0.05666878203862158, 0.7283068205304888, 0.6733369682517465, -0.9722045048895782, 0.1560235040317779, -0.6123914718301708, 0.520636691985273, -0.10134163434486876, -0.20689926812560167, -0.1392517047266304, 0.45299035349386485, -0.7149396910485919, -0.46172067251412274, -0.1211980867651945, 0.4347841233143599, 0.7144588912629475, -0.5419085241844375, 0.19900094785435063, -0.03951514134228429, 0.43797478159438685, 0.7150031568788673, -0.31780243606502134, -0.08936511347994691, -0.0024354042657879216, 0.2305495613345374, 0.7080887370238227, -0.3492416158151319, 0.9705747734096839, 0.6362495405064119, 0.018768228581393487, 0.9915367290255801, -0.03798425387907156, -0.6110750854040823, 0.9323926161478429, 0.9561276660839853, -0.026654261108640886, -0.4544312698695354, -0.13020532635422422, -0.21908206605042801, -0.15816617006570555, -0.5591028611700029, -0.8866401878469492, 0.9550024087839297, 0.20658752909995015, 0.7948178791895972, -0.5347198906985096, -0.6750577912815883, 0.7592477802718751, -0.5722330444689552, 0.1051510979235446, -0.9318045211608477, 0.15370117882000223, -0.37954435771720996, 0.5211986520449361, 0.4132602081722885, 0.8333093803026304, -0.44277297629366785, 0.7449371892686518, -0.5851829671944213, 0.009859827126259546, 0.5718409062200489, 0.21522564493115204, -0.4398550562789918, 0.7206180518568397, -0.4894021825486343, 0.25985264621889614, -0.9223940297209818, 0.43034590932902717, 0.08950729572487659, -0.6562956293639983, -0.9922425579462333, -0.8229033581672962, 0.5129435946364702, -0.4913883998076054, -0.8209793068100641, -0.2299704255797559, -0.37670052109762575, -0.0651006018263447, -0.6883116679004109, -0.8173303105578402, 0.6654807983152602, 0.6814943515989131, 0.9634474823281554, -0.4605372447001941, -0.6760151461349866, 0.3203387944103957, 0.5381061584242137, -0.7285315136235131, 0.9562849654547414, -0.27317808121047316, 0.72108475272603, 0.2697720121140714, -0.5179282287209581, -0.6144711180834692, 0.9500968795562044, -0.7575283467462872, 0.06881333665845202, 0.11915725664228183, -0.2305614562249545, 0.8327940981047306, -0.9546542855670506, 0.0026967800810677733, 0.020870603817710442, -0.29814779554191717, -0.625068369083539, 0.21428267884938856, 0.7928125567098583, -0.7372969436082935, -0.8236516249875507, -0.6156165282170032, 0.3179791428073173, 0.1982233047797115, 0.2324154103494338, -0.9953996751289766, 0.3781886295563326, 0.030554100979728327, 0.46901368039491986, 0.3879233976846519, -0.19671775100325828, 0.8686568220353765, -0.653676112667541, -0.4172555716272386, -0.16117378693529782, 0.886520191813104, 0.3653638389035343, -0.09108669159051663, 0.6046913812105243, -0.6527010442791725, -0.5807138980626352, -0.7128557858171838, -0.27843466357588564, -0.8881380841067046, 0.16497333401491487, 0.1349585876007251, -0.7997087603054942, -0.8230714175586493, 0.7499680878342534, 0.1891690310826355, -0.08398495606692458, -0.9722891809759897, -0.0320708404984249, -0.4000182137513333, 0.35233859182300065, 0.19526613749585064, 0.4024947080111889, -0.9452318564229345, 0.26964512898791226, -0.41070523573529605, -0.028675799249986422, -0.2741170684301266, 0.7376553280906304, -0.6717186958605381, -0.7763738529549011, -0.6039323610505212, 0.39526709455068887, -0.14987919714925346, 0.9511088064113913, 0.37237359053804253, -0.7070173012586913, -0.695220390638775, -0.33834042240127227, -0.09826256685992818, -0.6068897373622113, -0.28461603455883955, 0.04049320507321674, 0.7500252042293627, -0.37291998168504037, -0.27989196235526737, -0.39125733475451674, -0.16236192709364916, -0.9520556039519059, -0.4912312266459238, 0.5390778892492871, -0.417296911072637, 0.9824655861021601, -0.6489613422904228, -0.6992872735184514, -0.8857955777813631, -0.19687421491496782, 0.16456068551010783, -0.7553001140276245, -0.21021385315965824, 0.2887223126383389, -0.32526240972773945, -0.24000038107315502, 0.37006538663859945, 0.00318450989584651, 0.17178733875854224, -0.129273595504255, -0.6105457965065988, 0.16257693231355508, 0.38044700261604736, -0.655426977282495, 0.7835983265615614, 0.09165831109767542, 0.4790177893212124, 0.7598904071776722, -0.8047548119340067, -0.3196167854122427, 0.5049412576017347, -0.38518859779809933, 0.11739481260510432, -0.5714197978408997, -0.13636528052688424, -0.4710960784842093, -0.21760852783251394, 0.5991097969488588, -0.6927827235761808, 0.021524798298384606, -0.5138814630158941, 0.27943548402369944, 0.38422176305806666, -0.7292733826003754, 0.8716447614647782, -0.21496652325305732, -0.8074915371081774, -0.06070991974517659, -0.9635703571573282, 0.340466651509411, -0.16283376619068357, 0.46607645569079637, 0.17426847542844537, -0.6225852669648813, -0.032771743052659286, -0.5944056001179208, -0.7396179589897813, 0.6722132742835376, -0.9594841160363246, 0.35872276678965154, 0.937089607024417, 0.09687582860258503, -0.31776751421202754, 0.6120089199734904, -0.3117994415490215, -0.6827934572204446, -0.8047691555715168, -0.9258128023294003, 0.467117604393368, -0.03500612887320664, 0.03808027910114253, 0.8943929707591141, -0.551208529935584, 0.4730190622784156, -0.5050496699684923, 0.9484230624267658, 0.5602382308618787, -0.10289584759112036, 0.5552583854925897, -0.6454666613391844, -0.6856345664861281, 0.0408559866813496, -0.9355015044421116, -0.31693049988405075, 0.4594700974795034, -0.4545064730796502, 0.779347581077398, 0.28522700219431507, 0.6465210778360031, 0.08549340520590665, -0.32848928522520304, 0.39708475192559933, 0.7039444565340727, -0.6076566737156095, -0.019708710302806853, -0.20236172100439176, 0.6977410522710907, -0.5677732915528102, -0.4733266681132202, -0.4648864962355943, -0.2881955847954196, -0.10008412675605838, -0.39250615312520676, -0.07147793082097365, -0.9433546170642657, 0.3021998516850468, 0.3298423029026121, 0.6175081804057547, 0.8712487604604322, -0.9401427332853955, 0.7780429137647866, 0.90185174788543, -0.004184165240443294, -0.6474055702399013, -0.5300996450807909, -0.17044160698293376, -0.8104506523746546, -0.9251577914911215, -0.9539237544276504, -0.18950732031715933, 0.5085800735629222, -0.11189433573521956, -0.7665993012573751, 0.9252392717048492, -0.8569127541935273, 0.4914268317646451, 0.4159223175107196, -0.9028591003283115, -0.7345877161927243, 0.8415268608216973, 0.12452378806034026, 0.047389445195528124, 0.614572738327297, 0.9651963224172528, -0.8727636506201091, 0.720700578902336, 0.940540083049024, 0.28882712592740334, -0.03521150500089054, -0.5219676126585107, -0.6242942865326149, -0.43519729341995883, -0.21941686930998738, 0.6685906879224883, 0.9770973775792273, 0.5276774832991395, 0.16637841994568237, 0.3060612373668028, -0.7596754106133143, -0.8098258536399177, 0.552924333558563, 0.6832355281337747, 0.7257513236976354, -0.8264161894399973, -0.04398198564108968, 0.9908530447204793, 0.7176257599577098, -0.63001025969154, 0.2433068249246737, -0.8635666100718999, -0.5863188902662719, 0.6023184964104709, -0.42584552582903124, 0.12105794075171983, 0.30787333165397257, 0.635917482369226, -0.9470488591318083, -0.9891408584233647, -0.47802743600670206, 0.42070385006064126, 0.6571406734693086, -0.9247791059150594, -0.7785905051187911, -0.9245146457314637, 0.5074813559136395, 0.47803657162522595, -0.44510269678234105, 0.69282031766818, 0.34703057254246317, -0.9126797362932222, -0.20809842608590823, -0.10798846634520975, 0.9917617919227188, -0.06756948791340367, 0.45726969163537423, -0.6775376484719868, -0.4108278662728253, 0.7183255460066158, -0.4523640655995167, 0.15545305149304278, 0.11001335988500816, -0.049879825000665345, -0.26020096276657756, -0.8261818146047255, 0.4749838622645417, 0.21818827277876118, -0.19072613163147834, 0.9459840355985878, 0.4488481563492335, 0.41477045527520606, -0.6068009055511607, 0.9420607017056035, -0.6773670681349724, 0.18768151432277702, -0.7437960835892616, -0.5555833146329532, -0.03248719105774911, 0.9537191117326205, -0.7536909334982438, -0.049001696413266016, 0.8079777453001851, 0.32535698309058025, -0.8492827914252701, 0.48072967035033565, 0.6104033505713713, -0.12554984543479297, -0.5617895479764614, -0.47144724119103554, 0.13824815074666952, -0.7789797196536705, 0.5372396529133185, 0.8946004964652119, 0.4031799786240726, 0.7425221268663367, -0.031675734646421594, 0.1128849196258197, 0.8322921251898909, 0.029630636051976467, -0.09106524235706792, 0.15676298634283192, -0.3075809187973655, -0.01690375390061627, -0.859433999347764, -0.9500607158568679, -0.6538445670002673, -0.8413972861671348, -0.8709941607805249, -0.2990394495823694, -0.11607657045976816, 0.6198674719465471, -0.8019098179353128, 0.5456450363351397, 0.7964008431142793, 0.37141298456404503, 0.25870101030647574, -0.309805317980574, -0.7773966212757546, 0.2448518047451198, -0.7934069635763206, -0.8807885785731018, 0.7724304379926683, -0.03633208900457263, -0.526254269174582, 0.7992751857143734, 0.2544463158020043, -0.4074725976341609, 0.2228663535589488, 0.8219043801727688, -0.01870359457992765, 0.07093884084584468, 0.03463471207605573, -0.3805658575115829, -0.7855539100763846, -0.9038444304866389, -0.18319404010049367, 0.500743595742988, 0.1482314932317006, -0.5496406252099415, -0.5105357162272572, 0.781945440366207, -0.2340264659210891, 0.7313358184363736, 0.1113514080763851, 0.5702080396756359, 0.826294610224894, -0.2725138130790994, 0.46411103860153413, 0.2783975670788579, -0.011057737742087292, 0.21245362888194386, 0.9763755514174579, 0.41841099083452504, 0.6260107018238432, 0.6310694634681433, -0.31009255216036435, 0.42496064247086096, -0.6768474552729353, -0.04677310559987058, -0.7030929377517257, -0.6621286636286179, -0.31254226694461984, -0.23134991277961992, -0.3626175564322982, 0.46337579205006607, 0.6025968424232486, -0.2884480005263883, 0.978890156015499, 0.11469538041955585, 0.2188940261854666, 0.3995077356941288, 0.708133364428249, -0.014046970971510087, 0.7926537107999159, 0.0011379525763699494, -0.32892734211065977, -0.23601656284244243, 0.6863830141059659, 0.5891212928623424, -0.8691468366446937, 0.7237523732116089, 0.026162590832340182, -0.9901694400231793, 0.39474147077047794, -0.42746050935683244, -0.9329077361496438, 0.706124181088511, 0.21218961625983068, 0.7436129508656013, -0.41164306181271826, 0.18113948623953702, -0.3706066879154195, -0.6383461615118451, -0.5160202065048103, -0.031041000004604413, -0.962049802636614, -0.04612477260652059, 0.021695334563278212, 0.5622426050485334, -0.5533547972805992, 0.8388264942815851, -0.6508459181777639, -0.24261328897733048, 0.23138967893593243, -0.7081987993948891, 0.5524938309225351, 0.8560586232947549, -0.15712374599797552, -0.5683669853450777, -0.07551984848648385, 0.27781578473691937, -0.8437719417988887, -0.02358000774169189, -0.783789730845629, 0.18139213155783862, -0.015662437321664502, 0.82691455202461, 0.6308791445856647, -0.7856910943624631, -0.2967687478686085, -0.9095669558164421, -0.6262043884800992, -0.5236917647468924, 0.2134418567149261, -0.07875633537093574, 0.468738550458609, -0.5423225215863201, 0.4182948702700999, -0.8879396159420871, 0.5179558149793517, 0.36265895570921525, -0.995248777215912, 0.019212252753278536, 0.4923356836879218, 0.0860586559370311, -0.518851146177036, -0.07254223286752493, 0.8405906855182086, 0.5047860520770249, 0.5283592505485435, 0.5190068441029247, -0.314673831176864, 0.01493275481165024, -0.28994384073612123, 0.9984047894697374, 0.2698613362422744, -0.6068302727555244, -0.41825572003896716, -0.07966951618463236, -0.3654160026748079, 0.5989678722145653, -0.7665020623840659, 0.8519144540065651, -0.18463780049825584, 0.02351713237293529, -0.4312124753511555, -0.6316932433566782, -0.7323434887853686, 0.8337250087166908, -0.5556957822952848, 0.6047385446181504, -0.3752782343886445, -0.21210604639302688, -0.8682501422746636, 0.5332881859607685, -0.879592991347971, 0.9177228240978621, 0.6213310483877397, 0.8107194560108262, 0.4212209032859293, -0.9779641816192497, 0.359876092810965, 0.8019073410331101, -0.4328186620813763, -0.2877509040868136, 0.045852825715199774, -0.1195932174761325, 0.10076582582308946, 0.4174219638057335, -0.3273058111890026, 0.6185973982105004, 0.649466811939893, -0.5296361863926029, 0.07145239554360594, -0.7544330411641988, 0.137334250334624, 0.4156523868152151, -0.6978774039594042, 0.859576500251019, -0.9616156847903541, 0.48680910326434, -0.14204829485747061, 0.1539077604054946, -0.1883029286744169, 0.043916383660968394, 0.14769754400111212, 0.958718564000953, -0.2723017181239409, 0.39383133504482637, 0.8587485260970453, -0.760624647048884, -0.12067840684253417, -0.9521701781686296, 0.8866762300160582, -0.6725060228624693, -0.9387001021012455, 0.6170533470986563, 0.5131200948279666, 0.38713642281888827, -0.6230274352973368, 0.10988061485752865, 0.07679299218263758, -0.0783301165510113, 0.44023775921003394, 0.8017770853463966, 0.2111175990184211, -0.9239957806366597, 0.1664725741308819, -0.3286186661603012, -0.8991314641721844, -0.6280921793679006, -0.8051257467205526, -0.7816667011829148, -0.962724240115675, 0.7982608248885055, -0.07372162557052997, -0.1304039829266781, 0.16669120941496418, -0.8535684875107521, -0.2530091517208335, -0.3890289071692492, -0.2530242469958013, 0.8328063518734907, 0.4818246595547324, -0.6538280277763928, -0.3646421738944916, -0.22179247402741042, 0.35601224291089184, -0.07654869965397837, 0.2263250318828096, -0.5981365559630425, -0.6357519428644303, 0.8401303476846038]}' -H 'Content-Type: application/json'
}

function stop_docker() {
    cid=$(docker ps -aq --filter "name=test-comps-retrievers*")
    if [[ ! -z "$cid" ]]; then docker stop $cid && docker rm $cid && sleep 1s; fi
}

function main() {

    stop_docker

    build_docker_images
    start_service

    validate_microservice

    # stop_docker
    # echo y | docker system prune

}

main
